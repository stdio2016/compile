# parser

本程式可以檢查一個 P 語言程式是否符合語法，還有檢查語意

## 功能

1. 可以用 `//&S+` 列出每一行程式碼，`//&S-` 關閉此功能。預設為列出程式碼
2. 可以用 `//&T+` 列出 token，`//&T-` 關閉此功能。預設為列出 token
3. 可以判斷一個 P 語言程式是否符合語法。如果不符合語法，就會輸出錯誤的位置和錯誤 token
4. 判斷是否有重複定義的變數、常數、或是函數名，只要有錯誤，就會輸出錯誤的位置還有重複的名稱
5. 在每個 `begin ... end` 區塊結束後，顯示這個區塊的符號表的內容。可用 `//&D+` 註解開啟此功能，`//&D-` 關閉，預設是開啟
6. 檢查程式和函數結束的名稱是否和開頭的名稱一樣
7. 檢查變數、函數、運算式的型別，遇到不合法的型別就會輸出
8. 嘗試用 `read` 敘述或 `:=` 敘述更改常數和迴圈變數將會報錯
9. 允許在 `:=` 敘述、函數的引數、比較運算和算術運算將整數 (`integer`) 轉成實數 (`real`)
10. 為了避免重複的報錯，我參考 gcc 的作法，當子運算式因為語意錯誤而無法確定型別時，包含這個子運算式的運算式和敘述不會回報語意錯誤。例如：`1 + 2 * "e"` 中的 `2 * "e"` 是語意錯誤，則 `1 + 2 * "e"` 不會再回報語意錯誤
11. 如果函數有多個引數出錯，則這個程式會各個列出
12. 如果輸入的檔案沒有語法和語意錯誤，那麼程式就會說 `There is no syntactic and semantic error!`

## 新增檔案
有 errReport.c、errReport.h、semcheck.c 和 semcheck.h

### errReport.c 和 errReport.h
用來輸出語意錯誤的訊息，並計算語意錯誤的數量

### semcheck.c 和 semcheck.h
在 parser 建立語法樹之後，檢查運算式型別用的。我覺得語法檔最好只有語法相關的程式，所以我就把很多的語意規則檢查移到 semcheck.c 裡

## 對上次作業修改的地方

### scanner (tokens.l)
都是為了除錯
1. `else` 關鍵字的回報改成 `<KWelse>` 了
2. 在所有的字串處理程式都加上邊界檢查

### parser (parser.y)
1. 在語法規則的 action 檢查程式名和函數名
2. 把 expr 拆成好幾個非終端符，好讓我能比較方便的分析型別
3. 在解析運算式的時候會建立語法樹
4. 把函數型別存進 `funcReturnType`，就能檢查 return 型別了
5. 建立語法樹之後就會檢查型別
6. 為了收集到函數的引數，我把 `arg_list` 和 `arguments` 改成帶有屬性，屬性是一個 linked list
7. 處理 `if` 的型別時，為了避免 confilct，我把 `boolean_expr` 非終端符改成 `condition`，然後在 `condition` 規則內檢查 `boolean_expr` 是否是 `boolean` 型別
8. 如果語法正確，而且沒有語法錯誤，則輸出訊息
9. 更改 `%union` ，這樣才能把語法樹存進 attribute

### ast.c 和 ast.h
1. 增加結構：`struct Expr`，是語法樹的結構，裡面存了運算結果的型別、運算元、還有運算子
2. 增加結構：`struct ExprList`，是 linked list ，用來暫存函數的引數
3. 增加幾個方便型別檢查的 `struct Type` 操作
4. 加上 `Bool` 型別，處理布林值，還會檢查是否是 C99
5. 增加 `enum Operator` 標示運算子

### symtable.c 和 symtable.h
1. 更改 `addSymbol` 的傳回型別，因為我不但需要知道沒有成功加入符號，還要保留儲存名稱的記憶體
2. 迴圈變數補上整數 (`integer`) 型別
3. 統一 `struct Type` 的使用方式，一律用指標
4. 更改變數和引數宣告的處理程式，使得當宣告為陣列，而陣列的大小不合法時，會取消宣告陣列
5. 提供方法來查詢符號表
6. 更改函數宣告的處理程式，當函數傳回型別是陣列時，會取消宣告函數，因為函數不能傳回陣列

### Makefile
因為有新增檔案，所以就改掉 Makefile 了

## 執行平台

Ubuntu 17.10 和系計中的 Linux 主機 (我只測試過這兩個)

## 執行方法

首先，你需要安裝 flex 和 bison。

然後進入這個資料夾，在命令列輸入 `make`，就可以編譯這個程式

這個程式的命令列格式是 `./parser <檔案名>`

執行後，如果檔案是語法正確的 P 程式，就會顯示 `There is no syntactic and semantic error!`

要清除編譯中間檔，請在命令列輸入 `make clean`
